{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ course.title }} - Course Details</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script>
        function markLessonCompleted(lessonId) {
            fetch("{% url 'mark_lesson_complete' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    lesson_id: lessonId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById(`lesson-status-${lessonId}`).innerHTML = '<i class="fas fa-check-circle text-green-600"></i>';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</head>
<body class="bg-gray-50"> <!-- Light beige background to complement header and footer -->

    <!-- Navbar Section -->
    <nav class="bg-[#77390c] shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-white">ArtiQuity</a>
            <div class="hidden md:flex items-center space-x-4">
                <a href="#" class="text-white hover:text-gray-200 transition duration-300">Home</a>
                <a href="#" class="text-white hover:text-gray-200 transition duration-300">Courses</a>
                <a href="#" class="text-white hover:text-gray-200 transition duration-300">About</a>
                <a href="#" class="text-white hover:text-gray-200 transition duration-300">Contact</a>
            </div>
            <div class="relative group">
                <button class="flex items-center space-x-3 bg-gray-100 text-gray-700 px-4 py-2 rounded-full focus:outline-none hover:bg-gray-200 transition duration-300">
                    <img src="{% if request.user.profile_picture %} {{ request.user.profile_picture.url }} {% else %} https://cdn.pixabay.com/photo/2020/07/01/12/58/icon-5359554_1280.png {% endif %}" 
                         alt="Profile" class="w-10 h-10 rounded-full shadow-md object-cover">
                    <span class="font-medium text-gray-800">{{ request.user.username }}</span>
                    <i class="fas fa-caret-down text-gray-500"></i>
                </button>
                <div class="hidden group-hover:flex flex-col absolute right-0 mt-2 w-56 bg-white border border-gray-200 shadow-lg rounded-md group-focus-within:flex transition ease-in-out duration-150 z-50">
                    <a href="#" class="block px-4 py-3 text-gray-600 hover:bg-gray-100 border-b">View Profile</a>
                    {% if role == 'student' %}
                    <a href="{% url 'enrolled_courses' %}" class="block px-4 py-3 text-gray-600 hover:bg-gray-100 border-b">My Learning</a>
                    <a href="{% url 'view_cart' %}" class="block px-4 py-3 text-gray-600 hover:bg-gray-100 border-b">My Cart</a>
                    {% endif %}
                    <a href="#" class="block px-4 py-3 text-gray-600 hover:bg-gray-100 border-b">Account Settings</a>
                    <a href="{% url 'user_logout' %}" class="block px-4 py-3 text-red-600 hover:bg-gray-100">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Course Details Section -->
    <div class="container mx-auto px-4 py-12">
        <div class="bg-white shadow-md rounded-lg p-8 border-t-4 border-[#b5651d]">
            <h1 class="text-4xl font-bold text-[#5a3220] mb-4">{{ course.title }}</h1>
            <p class="text-lg text-[#7a5230] mb-6">{{ course.description }}</p>

            <h2 class="text-3xl font-semibold text-[#b5651d] mb-4">Course Lessons</h2>
            {% if role == 'student' and visibility %}
            <div class="mb-6">
                <h3 class="text-2xl font-semibold text-[#5a3220]">Your Progress</h3>
                <div class="relative pt-1 mt-2">
                    <div class="overflow-hidden h-10 text-xs flex rounded bg-gray-300">
                        <div class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-green-400 to-green-600 transition-all duration-500 ease-in-out" 
                             style="width: {{ progress_percentage }}%">
                            <span class="font-bold text-lg">{{ progress_percentage|floatformat:1 }}%</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
<!-- Reviews Section -->
<div class="container mx-auto px-4 py-8">
    <h2 class="text-3xl font-semibold text-[#5a3220] mb-4">Course Reviews</h2>
    <div class="flex items-center mb-4">
        <h3 class="text-2xl font-semibold text-[#5a3220] mr-4">Course Rating:</h3>

        <div class="flex items-center mb-2">
            <span class="text-lg font-bold mr-2">Rating:</span>
            <div class="flex items-center">
                {% for i in star_range %}
                    {% if course.average_rating >= i|add:"1" %}
                        <i class="fas fa-star text-yellow-400"></i> <!-- Full star -->
                    {% elif course.average_rating >= i|add:"0.5" %}
                        <i class="fas fa-star-half-alt text-yellow-400"></i> <!-- Half star -->
                    {% else %}
                        <i class="far fa-star text-yellow-400"></i> <!-- Empty star -->
                    {% endif %}
                {% endfor %}
                <span class="text-gray-600 ml-2">({{ course.average_rating }}/5)</span>
            </div>
        </div>
        </div>

    
    <!-- Display existing reviews -->
    <div class="space-y-6">
        {% for review in reviews %}
        <div class="p-4 rounded-lg shadow-md bg-gray-100">
            <div class="flex justify-between items-center">
                <h4 class="text-lg font-bold">{{ review.student.username }}</h4>
                
                <div class="flex items-center mb-2">
                    
                    <div class="flex items-center">
                        {% for i in star_range %}
                            {% if review.rating >= i|add:"1" %}
                                <i class="fas fa-star text-yellow-400"></i> <!-- Full star -->
                            {% elif review.rating >= i|add:"0.5" %}
                                <i class="fas fa-star-half-alt text-yellow-400"></i> <!-- Half star -->
                            {% else %}
                                <i class="far fa-star text-yellow-400"></i> <!-- Empty star -->
                            {% endif %}
                        {% endfor %}
                        <span class="text-gray-600 ml-2">({{ review.rating }}/5)</span>
                    </div>
                </div>
            </div>
            <p class="text-gray-700 mt-2">{{ review.comment }}</p>
            <p class="text-gray-500 text-sm">{{ review.review_date|date:"F j, Y" }}</p>
        </div>
        {% empty %}
        <p class="text-gray-500">No reviews yet. Be the first to review this course!</p>
        {% endfor %}
    </div>

    <!-- Add a Review Form -->
    {% if role == 'student' and visibility %}
    <div class="mt-8">
        <h3 class="text-2xl font-semibold text-[#5a3220]">Leave a Review</h3>
        <form method="post" class="mt-4 bg-white p-4 rounded-lg shadow-md">
            {% csrf_token %}
            {{ review_form.as_p }}
            <button type="submit" name="submit_review" class="px-4 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700">
                Submit Review
            </button>
        </form>
    </div>
    {% endif %}
</div>
           
{% if lessons %}
<div class="space-y-6">
    {% for lesson in lessons %}
        <div class="bg-[#f2e4db] p-4 rounded-lg shadow-sm hover:shadow-md transition duration-300 border-l-4 border-[#77390c]">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h3 class="text-lg font-semibold text-[#5a3220]">{{ lesson.title }}</h3>
                    {% if role == 'instructor' %}
                        <div class="flex items-center space-x-3">
                            <a href="{% url 'edit_lesson' lesson.id %}" class="text-[#e1b12c] hover:text-[#fbc531] transition duration-300" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'delete_lesson' lesson.id %}" class="text-[#d63031] hover:text-[#c0392b] transition duration-300" title="Delete">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    {% endif %}
                </div>
                {% if role == 'student' %}
                    <span id="lesson-status-{{ lesson.id }}">
                        {% if lesson.is_completed %}
                            <i class="fas fa-check-circle text-green-600"></i>
                        {% else %}
                            <i class="fas fa-times-circle text-red-600"></i>
                        {% endif %}
                    </span>
                {% endif %}
            </div>
            <p class="text-[#7a5230] mt-2">{{ lesson.content }}</p>

            {% if role == 'instructor' %}
                {% if lesson.video_file %}
                <div>
                    <div class="flex">
                        <video controls class="w-1/2 md:w-1/3 rounded-md shadow-sm" style="max-height: 250px;">
                            <source src="{{ lesson.video_file.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
                {% endif %}
            {% endif %}

            {% if role == 'student' %}
                {% if visibility %}
                    {% if lesson.video_file %}
                        <div>
                            <video 
                                id="video-{{ lesson.id }}" 
                                controls 
                                class="w-1/2 md:w-1/3 rounded-md shadow-sm" 
                                style="max-height: 250px;"
                                onended="markLessonCompleted({{ lesson.id }})">
                                <source src="{{ lesson.video_file.url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    {% endif %}
                {% else %}
                    <video 
                        controls 
                        class="w-1/2 md:w-1/3 rounded-md shadow-sm" 
                        style="max-height: 250px;" 
                        onplay="this.pause(); alert('Please enroll in the course first');">
                        <source src="{{ lesson.video_file.url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                {% endif %}
            {% endif %}
        </div>
    {% endfor %}
</div>
{% else %}
    <p class="text-[#d63031]">No lessons available for this course yet.</p>
{% endif %}

            {% if role == 'instructor' %}
            <div class="mt-10 text-center flex justify-center space-x-8">
                <a href="{% url 'instructor_dashboard' %}" class="text-[#1b4965] font-semibold hover:text-[#126782] transition duration-300 flex items-center space-x-2">
                    <i class="fas fa-arrow-left text-[#1b4965] bg-[#d9f2f8] rounded-full p-2"></i>
                    <span class="no-underline hover:underline">Back to Dashboard</span>
                </a>
                <a href="{% url 'create_lesson' course.id %}" class="text-[#e63946] font-semibold hover:text-[#bf3b3f] transition duration-300 flex items-center space-x-2">
                    <i class="fas fa-plus-circle text-[#e63946] bg-[#fde8e8] rounded-full p-2"></i>
                    <span class="no-underline hover:underline">Add Lesson</span>
                </a>
            </div>
            {% endif %}
            {% if role == 'student' %}
            <div class="mt-10 text-center flex justify-center space-x-8">
                <a href="{% url 'student_dashboard' %}" class="text-[#5a3220] font-semibold hover:text-[#b5651d] transition duration-300 flex items-center space-x-2">
                    <i class="fas fa-arrow-left text-[#5a3220] bg-[#f2e4db] rounded-full p-2"></i>
                    <span class="no-underline hover:underline">Back to Dashboard</span>
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="bg-[#77390c] shadow-md py-6 mt-10">
        <div class="container mx-auto text-center">
            <p class="text-white">&copy; 2024 ArtiQuity. All Rights Reserved.</p>
            <a href="#" class="text-white hover:text-gray-300 mx-2">Privacy Policy</a> | 
            <a href="#" class="text-white hover:text-gray-300 mx-2">Terms of Service</a>
        </div>
    </footer>
</body>
</html>
